default_platform(:ios)

FLAVORS = {
  dev:  { xcconfig: "Flutter/Dev.xcconfig",  plist: "Runner/GoogleService-Info-dev.plist",  dart: "lib/main_development.dart" },
  stg:  { xcconfig: "Flutter/Stg.xcconfig",  plist: "Runner/GoogleService-Info-stg.plist",  dart: "lib/main_staging.dart" },
  # Ğ£Ğ’ĞĞ“Ğ: Ğ¿ĞµÑ€ĞµĞºĞ¾Ğ½Ğ°Ğ¹ÑÑ, Ñ‰Ğ¾ Prod.xcconfig Ñ–ÑĞ½ÑƒÑ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ¼Ñ–Ğ½Ğ¸ Ğ½Ğ° Release.xcconfig
  prod: { xcconfig: "Flutter/Prod.xcconfig", plist: "Runner/GoogleService-Info-prod.plist", dart: "lib/main_production.dart" }
}

platform :ios do
  before_all do
    UI.message("ğŸ Using xcconfig per flavor + copying Firebase plist")
  end

  desc "DEV (Simulator, Debug)"
  lane :dev do
    build_sim(flavor: :dev)
  end

  desc "STG (Simulator, Debug)"
  lane :stg do
    build_sim(flavor: :stg)
  end

  desc "PROD archive (Release, App Store)"
  lane :prod_archive do
    flavor = FLAVORS[:prod]
    copy_firebase(from: flavor[:plist])
    build_ios_app(
      scheme: "Runner",
      xcconfig: flavor[:xcconfig],
      configuration: "Release",
      clean: true,
      export_method: "app-store"
    )
  end

  private_lane :build_sim do |options|
    key = (options[:flavor] || :dev).to_sym
    flavor = FLAVORS[key]
    UI.user_error!("Unknown flavor: #{key}") if flavor.nil?

    copy_firebase(from: flavor[:plist])

    # Ğ¾Ğ¿Ñ†Ñ–Ğ¹Ğ½Ğ¾: ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Dart Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹ Ğ· ĞºĞ¾Ñ€ĞµĞ½Ñ iOS-Ğ¿Ñ€Ğ¾Ñ”ĞºÑ‚Ñƒ
    sh("cd .. && flutter pub get")

    build_ios_app(
      scheme: "Runner",
      xcconfig: flavor[:xcconfig],
      sdk: "iphonesimulator",
      destination: "generic/platform=iOS Simulator",
      configuration: "Debug",
      skip_archive: true,
      skip_codesigning: true,
      clean: true,
      xcargs: "FLUTTER_TARGET=#{flavor[:dart]}"
    )

    UI.message("â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñƒ Flutter: flutter run --target #{flavor[:dart]}")
  end

  private_lane :copy_firebase do |options|
  # __dir__ => ios/fastlane
  ios_dir     = File.expand_path("..", __dir__)                           # ios
  source_rel  = options[:from]                                            # Runner/GoogleService-Info-*.plist
  source_abs  = File.expand_path(source_rel, ios_dir)                     # ios/Runner/GoogleService-Info-*.plist
  target_abs  = File.expand_path("Runner/GoogleService-Info.plist", ios_dir)

  UI.user_error!("Missing Firebase plist: #{source_abs}") unless File.exist?(source_abs)

  require 'fileutils'
  FileUtils.cp(source_abs, target_abs)
  UI.message("ğŸ“‹ Copied #{source_abs} -> #{target_abs}")
end

end

